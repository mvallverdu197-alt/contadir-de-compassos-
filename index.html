<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Compassos d'Espera</title>

<!-- PWA Manifest inline -->
<link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22Compassos%20d%27Espera%22%2C%22short_name%22%3A%22Compassos%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230a0a0f%22%2C%22theme_color%22%3A%22%23e8c84a%22%7D">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Compassos">
<meta name="theme-color" content="#e8c84a">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ZERO external dependencies â€” funciona offline i com a
   fitxer local en Chrome / Safari / Firefox / mÃ²bil
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:#0a0a0f; --panel:#13131e; --accent:#e8c84a; --accent2:#5a9cf5;
  --danger:#ff3c3c; --ok:#3cff8f; --dim:#2a2a3a; --text:#f0f0f5; --muted:#55556a;
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html { height:100%; background:var(--bg); }

body {
  background:var(--bg); color:var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
  display:flex; flex-direction:column; align-items:center;
  min-height:100%; padding:10px 6px 30px;
  /* NO overflow:hidden, NO user-select:none al body, NO touch-action al body */
}

/* Inputs i elements de formulari: sempre accessibles */
input, button, select, textarea {
  font-family: inherit;
  touch-action: manipulation;
}
input[type="number"], input[type="text"] {
  /* ExplÃ­citament permetre selecciÃ³ i tÃ ctil */
  user-select: text !important;
  -webkit-user-select: text !important;
  touch-action: auto !important;
  pointer-events: auto !important;
}

.app {
  width: min(560px, 100%);
  display: flex; flex-direction: column; gap: 10px;
}

/* â”€â”€ HEADER â”€â”€ */
header { text-align:center; padding: 2px 0 6px; }
header h1 {
  font-size: clamp(1.3rem, 5vw, 1.8rem);
  font-weight: 900; letter-spacing: .1em;
  color: var(--accent); line-height: 1;
}
header p { font-size: .6rem; letter-spacing: .28em; color: var(--muted); text-transform: uppercase; margin-top: 3px; }

/* â”€â”€ CARD â”€â”€ */
.card {
  background: var(--panel); border: 1px solid var(--dim); border-radius: 12px;
  padding: 12px 14px; display: flex; flex-direction: column; gap: 9px;
}
.lbl { font-size: .58rem; letter-spacing: .2em; color: var(--muted); text-transform: uppercase; display: block; }
.row-sb { display: flex; align-items: center; justify-content: space-between; gap: 8px; }

/* â”€â”€ SEQUENCE LIST â”€â”€ */
.seq-list {
  display: flex; flex-direction: column; gap: 6px;
  max-height: 175px; overflow-y: auto; padding-right: 2px;
}
.seq-list::-webkit-scrollbar { width: 3px; }
.seq-list::-webkit-scrollbar-thumb { background: var(--dim); border-radius: 2px; }

.seq-item {
  display: flex; align-items: center; gap: 8px;
  background: var(--bg); border: 1px solid var(--dim); border-radius: 8px;
  padding: 8px 10px; cursor: pointer;
  transition: border-color .15s, box-shadow .15s;
  touch-action: manipulation;
}
.seq-item.active { border-color: var(--accent); box-shadow: 0 0 10px rgba(232,200,74,.15); }
.seq-item.done-item { opacity: .35; }
.seq-num { font-weight: 900; font-size: 1.15rem; color: var(--accent); min-width: 38px; text-align: center; line-height: 1; }
.seq-sig { font-weight: 700; font-size: .9rem; color: var(--accent2); min-width: 38px; }
.seq-name { flex: 1; font-size: .62rem; color: var(--muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.seq-del {
  background: none; border: none; color: #554455; font-size: 1rem;
  cursor: pointer; padding: 3px 7px; transition: color .15s;
  touch-action: manipulation; line-height: 1;
}
.seq-del:active { color: var(--danger); }

/* â”€â”€ ADD ROW â”€â”€ */
.add-row { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }

.n-input {
  background: var(--bg); border: 1.5px solid var(--dim); border-radius: 7px;
  color: var(--text); font-weight: 900; font-size: 1.15rem;
  text-align: center; padding: 7px 4px; outline: none; width: 64px;
  -moz-appearance: textfield; transition: border-color .15s;
  /* Inputs MUST allow interaction */
  user-select: text; -webkit-user-select: text;
  touch-action: auto; pointer-events: auto;
  -webkit-appearance: none; appearance: none;
}
.n-input::-webkit-outer-spin-button, .n-input::-webkit-inner-spin-button { -webkit-appearance: none; }
.n-input:focus { border-color: var(--accent); outline: none; }

.nom-input {
  background: var(--bg); border: 1.5px solid var(--dim); border-radius: 7px;
  color: var(--text); font-size: .7rem; text-align: left;
  padding: 7px 8px; outline: none; width: 105px;
  transition: border-color .15s;
  user-select: text; -webkit-user-select: text;
  touch-action: auto; pointer-events: auto;
}
.nom-input:focus { border-color: var(--accent); outline: none; }

.sig-grid { display: flex; gap: 4px; flex-wrap: wrap; }
.sig-btn {
  background: var(--bg); border: 1.5px solid var(--dim); border-radius: 6px;
  color: var(--muted); font-weight: 700; font-size: .82rem;
  padding: 5px 8px; cursor: pointer; transition: all .12s;
  touch-action: manipulation; white-space: nowrap;
}
.sig-btn:active { transform: scale(.91); }
.sig-btn.sel { background: rgba(90,156,245,.15); border-color: var(--accent2); color: var(--accent2); }

.add-btn {
  background: rgba(232,200,74,.12); border: 1.5px solid rgba(232,200,74,.35);
  border-radius: 7px; color: var(--accent); font-weight: 700;
  font-size: .65rem; letter-spacing: .07em; padding: 8px 14px;
  cursor: pointer; white-space: nowrap; text-transform: uppercase;
  transition: background .12s, transform .08s;
  touch-action: manipulation;
}
.add-btn:active { background: rgba(232,200,74,.28); transform: scale(.96); }

/* â”€â”€ STRIP â”€â”€ */
.strip { display: flex; gap: 8px; }
.strip .card { flex: 1; }

/* â”€â”€ WARN INPUT â”€â”€ */
.warn-input {
  background: var(--bg); border: 1.5px solid var(--dim); border-radius: 7px;
  color: var(--danger); font-weight: 900; font-size: 1.3rem;
  width: 56px; text-align: center; padding: 6px; outline: none;
  -moz-appearance: textfield;
  user-select: text; -webkit-user-select: text; touch-action: auto;
}
.warn-input::-webkit-outer-spin-button, .warn-input::-webkit-inner-spin-button { -webkit-appearance: none; }
.warn-input:focus { border-color: var(--danger); }

/* â”€â”€ TOGGLE â”€â”€ */
.tog-wrap { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
.tog-desc { font-size: .6rem; color: var(--muted); line-height: 1.45; }
.tog-lbl { position: relative; width: 48px; height: 26px; cursor: pointer; flex-shrink: 0; display: inline-block; }
.tog-lbl input { opacity: 0; width: 0; height: 0; position: absolute; }
.tog-track { position: absolute; inset: 0; border-radius: 13px; background: var(--dim); transition: background .2s; }
.tog-lbl input:checked ~ .tog-track { background: rgba(232,200,74,.35); border: 1px solid var(--accent); }
.tog-thumb { position: absolute; top: 3px; left: 3px; width: 20px; height: 20px; border-radius: 50%; background: var(--muted); transition: transform .2s, background .2s; }
.tog-lbl input:checked ~ .tog-track .tog-thumb { transform: translateX(22px); background: var(--accent); }

/* â”€â”€ DISPLAY â”€â”€ */
.display {
  background: var(--panel); border: 2px solid var(--dim); border-radius: 18px;
  padding: 14px 16px 12px; text-align: center; overflow: hidden;
  transition: border-color .2s, box-shadow .2s;
}
.display.warning { border-color: var(--danger); animation: pglow .6s ease-in-out infinite alternate; }
.display.done    { border-color: var(--ok); box-shadow: 0 0 28px rgba(60,255,143,.2); }
@keyframes pglow { from { box-shadow: 0 0 8px rgba(255,60,60,.15); } to { box-shadow: 0 0 32px rgba(255,60,60,.38); } }
@keyframes sflash { 0% { opacity:.2; } 100% { opacity:1; } }
.sflash { animation: sflash .4s ease; }

.sec-hdr {
  display: flex; align-items: center; justify-content: center; gap: 10px;
  margin-bottom: 5px; font-size: .56rem; letter-spacing: .18em; text-transform: uppercase;
}
.sec-sig  { font-weight: 900; font-size: 1.1rem; color: var(--accent2); }
.sec-name { color: var(--muted); }
.sec-prog { color: var(--muted); font-size: .5rem; }

.disp-top { display: flex; align-items: flex-start; justify-content: center; gap: 14px; }
.meas-blk { display: flex; flex-direction: column; align-items: center; }
.disp-lbl { font-size: .5rem; letter-spacing: .24em; color: var(--muted); text-transform: uppercase; margin-bottom: 2px; }

.big-num {
  font-weight: 900; font-size: clamp(6rem, 22vw, 9rem); line-height: .9;
  color: var(--accent); transition: color .15s; display: block;
}
.display.warning .big-num { color: var(--danger); }
.display.done    .big-num { color: var(--ok); }
.big-num.pop { animation: pop .13s ease; }
@keyframes pop { 0%{transform:scale(1)} 55%{transform:scale(1.09)} 100%{transform:scale(1)} }
.of-total { font-size: .62rem; color: var(--muted); letter-spacing: .13em; margin-top: 3px; }

.beat-blk { display: flex; flex-direction: column; align-items: center; gap: 6px; padding-top: 6px; }
.beat-row { display: flex; gap: 9px; align-items: center; }
.bdot {
  width: 13px; height: 13px; border-radius: 50%;
  background: var(--dim); border: 1.5px solid var(--dim);
  transition: background .07s, border-color .07s, transform .07s, box-shadow .07s;
}
.bdot.on { background: var(--accent2); border-color: var(--accent2); transform: scale(1.3); box-shadow: 0 0 8px var(--accent2); }
.bdot.acc { border-color: rgba(232,200,74,.5); }
.bdot.sub { width: 8px; height: 8px; }
.bdot.sub.on { background: rgba(90,156,245,.65); border-color: var(--accent2); transform: scale(1.25); }
.beat-lbl { font-size: .52rem; letter-spacing: .18em; color: var(--muted); text-transform: uppercase; }

.prog-wrap { height: 4px; background: var(--dim); border-radius: 2px; margin-top: 12px; overflow: hidden; }
.prog-bar { height: 100%; border-radius: 2px; width: 0%; transition: width .12s ease, background .2s; background: var(--accent); }
.display.warning .prog-bar { background: var(--danger); }
.display.done    .prog-bar { background: var(--ok); }

/* â”€â”€ STATUS â”€â”€ */
.status { text-align: center; font-size: .64rem; letter-spacing: .12em; color: var(--muted); min-height: 1.2em; text-transform: uppercase; transition: color .15s; }
.status.warn { color: var(--danger); }
.status.done { color: var(--ok); }
.status.next { color: var(--accent2); }

/* â”€â”€ TAP ZONE â”€â”€ */
.tap-zone {
  background: var(--panel); border: 2px solid var(--dim); border-radius: 20px;
  height: 140px; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  cursor: pointer; touch-action: manipulation;
  transition: background .1s, border-color .1s, transform .08s;
  position: relative; overflow: hidden; gap: 5px;
  /* User select off ONLY here */
  user-select: none; -webkit-user-select: none;
}
.tap-zone:active, .tap-zone.pressing {
  background: #1c1c2a; transform: scale(.97); border-color: var(--accent2);
}
.tap-lbl { font-weight: 900; font-size: 2.6rem; letter-spacing: .12em; color: var(--text); pointer-events: none; line-height: 1; }
.tap-hint { font-size: .58rem; letter-spacing: .1em; color: var(--muted); pointer-events: none; }
.ripple {
  position: absolute; border-radius: 50%; background: rgba(90,156,245,.22);
  transform: scale(0); animation: ripple .55s linear; pointer-events: none;
}
@keyframes ripple { to { transform: scale(4); opacity: 0; } }

/* â”€â”€ CONTROLS â”€â”€ */
.controls { display: flex; gap: 8px; }
.ctrl-btn {
  flex: 1; background: var(--dim); border: none; border-radius: 9px; color: var(--text);
  font-size: .62rem; letter-spacing: .07em; text-transform: uppercase;
  padding: 11px 6px; cursor: pointer; touch-action: manipulation;
  transition: background .12s, transform .08s;
  user-select: none; -webkit-user-select: none;
}
.ctrl-btn:active { background: #3a3a5a; transform: scale(.96); }
.ctrl-btn.primary { background: rgba(232,200,74,.12); border: 1px solid rgba(232,200,74,.3); color: var(--accent); }
.ctrl-btn.primary:active { background: rgba(232,200,74,.25); }

/* â”€â”€ GP BAR â”€â”€ */
.gp-bar { display: flex; align-items: center; justify-content: center; gap: 7px; font-size: .55rem; letter-spacing: .11em; color: var(--muted); text-transform: uppercase; }
.gp-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--dim); flex-shrink: 0; transition: background .3s; }
.gp-dot.on { background: var(--ok); box-shadow: 0 0 5px var(--ok); }

/* â”€â”€ OVERLAY â”€â”€ */
.overlay {
  position: fixed; inset: 0; background: rgba(8,8,14,.9);
  display: flex; align-items: center; justify-content: center; z-index: 200;
  opacity: 0; pointer-events: none; transition: opacity .25s;
}
.overlay.show { opacity: 1; pointer-events: all; }
.overlay-box {
  text-align: center; padding: 36px 48px; background: var(--panel);
  border: 2px solid var(--ok); border-radius: 20px;
  box-shadow: 0 0 50px rgba(60,255,143,.25);
}
.overlay-box h2 { font-weight: 900; font-size: 3.5rem; letter-spacing: .08em; color: var(--ok); line-height: 1; }
.overlay-box p  { font-size: .68rem; letter-spacing: .16em; color: var(--muted); margin-top: 10px; }
</style>
</head>
<body>
<div class="app">

  <header>
    <h1>ğŸ¼ COMPASSOS D'ESPERA</h1>
    <p>Gamepad Â· TÃ ctil Â· Teclat</p>
  </header>

  <!-- SEQÃœÃˆNCIA -->
  <div class="card">
    <div class="row-sb">
      <span class="lbl">SeqÃ¼Ã¨ncia de seccions</span>
      <span id="seqTotal" style="font-size:.58rem;color:var(--accent2)"></span>
    </div>
    <div class="seq-list" id="seqList"></div>
    <span class="lbl">Afegir secciÃ³</span>
    <div class="add-row">
      <input class="n-input" type="number" id="newBars" value="16" min="1" max="999" inputmode="numeric">
      <div class="sig-grid" id="newSigGrid"></div>
      <input class="nom-input" type="text" id="newName" placeholder="nom (opcional)" maxlength="20" autocomplete="off" autocorrect="off" spellcheck="false">
      <button class="add-btn" type="button" id="btnAdd">+ Afegir</button>
    </div>
  </div>

  <!-- AVÃS + SUBDIVISIÃ“ -->
  <div class="strip">
    <div class="card">
      <span class="lbl">AvÃ­s finals</span>
      <div style="display:flex;align-items:center;gap:7px;margin-top:2px">
        <input class="warn-input" type="number" id="warnInput" value="5" min="1" max="99" inputmode="numeric">
        <span style="font-size:.58rem;color:var(--muted)">compassos</span>
      </div>
    </div>
    <div class="card" style="flex:2">
      <span class="lbl">PolsaciÃ³</span>
      <div class="tog-wrap" style="margin-top:4px">
        <div class="tog-desc" id="subdivDesc">1 cop = 1 temps</div>
        <label class="tog-lbl">
          <input type="checkbox" id="subdivToggle">
          <div class="tog-track"><div class="tog-thumb"></div></div>
        </label>
      </div>
      <div id="subdivDetail" style="font-size:.52rem;color:var(--accent);letter-spacing:.07em;min-height:.9em;margin-top:2px"></div>
    </div>
  </div>

  <!-- DISPLAY -->
  <div class="display" id="display">
    <div class="sec-hdr">
      <span class="sec-sig" id="secSig">â€”</span>
      <span class="sec-name" id="secName"></span>
      <span class="sec-prog" id="secProg"></span>
    </div>
    <div class="disp-top">
      <div class="meas-blk">
        <div class="disp-lbl">Compassos restants</div>
        <span class="big-num" id="bigNum">â€”</span>
        <div class="of-total" id="ofTotal"></div>
      </div>
      <div class="beat-blk">
        <div class="beat-lbl" id="beatLbl"></div>
        <div class="beat-row" id="beatDots"></div>
        <div class="beat-row" id="subDots" style="gap:5px;margin-top:4px"></div>
      </div>
    </div>
    <div class="prog-wrap"><div class="prog-bar" id="progBar"></div></div>
  </div>

  <div class="status" id="statusLine">Afegeix seccions i prem START</div>

  <div class="tap-zone" id="tapZone">
    <span class="tap-lbl" id="tapLabel">TAP Â· POLSA</span>
    <span class="tap-hint" id="tapHint">Toca aquÃ­ Â· L2/LT Â· Espai</span>
  </div>

  <div class="controls">
    <button class="ctrl-btn" type="button" id="btnReset">â†º Reiniciar</button>
    <button class="ctrl-btn primary" type="button" id="btnStart">â–¶ START</button>
  </div>

  <div class="gp-bar">
    <div class="gp-dot" id="gpDot"></div>
    <span id="gpLabel">Gamepad no detectat</span>
  </div>
</div>

<div class="overlay" id="overlay">
  <div class="overlay-box">
    <h2>âœ“ FI!</h2>
    <p>Tota la seqÃ¼Ã¨ncia completada<br>
    <small style="opacity:.45;font-size:.8em">Toca per tancar</small></p>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COMPASSOS D'ESPERA â€” funciona offline com a fitxer local
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
'use strict';

// â”€â”€ DADES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var SIGS = [
  {id:'2/4',  beats:2},
  {id:'3/4',  beats:3},
  {id:'4/4',  beats:4},
  {id:'6/8',  beats:2},
  {id:'9/8',  beats:3},
  {id:'12/8', beats:4}
];

// SeqÃ¼Ã¨ncia inicial d'exemple
var sequence = [
  {bars:33, sigId:'4/4', name:''},
  {bars:23, sigId:'4/4', name:''},
  {bars:20, sigId:'4/4', name:''},
  {bars:32, sigId:'3/4', name:''}
];

var newSigIdx  = 2;   // 4/4 per defecte al formulari
var warnAt     = 5;
var subdivMode = false;
var running    = false;
var secIdx     = 0;
var remainingBars = 0;
var currentBeat   = 0;
var currentSub    = 0;
var tapCount      = 0;
var tapsNeeded    = 0;
var canVibrate    = (typeof navigator.vibrate === 'function');

// Gamepad
var gpConnected = false, gpRAF = null, lastBtns = {};
var COUNT_BTNS = [0,2,4,6], START_BTNS = [9], RESET_BTNS = [8];

// â”€â”€ DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function q(id) { return document.getElementById(id); }
var display    = q('display');
var bigNum     = q('bigNum');
var ofTotal    = q('ofTotal');
var progBar    = q('progBar');
var statusLine = q('statusLine');
var tapZone    = q('tapZone');
var tapLabel   = q('tapLabel');
var tapHint    = q('tapHint');
var btnStart   = q('btnStart');
var btnReset   = q('btnReset');
var warnInput  = q('warnInput');
var gpDot      = q('gpDot');
var gpLabel    = q('gpLabel');
var overlay    = q('overlay');
var seqList    = q('seqList');
var seqTotal   = q('seqTotal');
var newSigGrid = q('newSigGrid');
var newBarsIn  = q('newBars');
var newNameIn  = q('newName');
var btnAdd     = q('btnAdd');
var subdivToggle = q('subdivToggle');
var subdivDesc   = q('subdivDesc');
var subdivDetail = q('subdivDetail');
var beatDots   = q('beatDots');
var subDots    = q('subDots');
var beatLbl    = q('beatLbl');
var secSig     = q('secSig');
var secName    = q('secName');
var secProg    = q('secProg');

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clamp(v,a,b) { return Math.max(a, Math.min(b, v)); }
function getSig(id) {
  for (var i=0; i<SIGS.length; i++) { if (SIGS[i].id === id) return SIGS[i]; }
  return SIGS[2];
}
function curSig() { return getSig(sequence[secIdx] ? sequence[secIdx].sigId : '4/4'); }
function tapsFor(sig) { return sig.beats * (subdivMode ? 2 : 1); }

// â”€â”€ SIG GRID (formulari) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildNewSigGrid() {
  newSigGrid.innerHTML = '';
  for (var i=0; i<SIGS.length; i++) {
    (function(idx) {
      var b = document.createElement('button');
      b.className = 'sig-btn' + (idx === newSigIdx ? ' sel' : '');
      b.textContent = SIGS[idx].id;
      b.type = 'button';
      b.addEventListener('click', function() {
        newSigIdx = idx;
        buildNewSigGrid();
      });
      newSigGrid.appendChild(b);
    })(i);
  }
}

// â”€â”€ LLISTA DE SECCIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSeqList() {
  seqList.innerHTML = '';
  for (var i=0; i<sequence.length; i++) {
    (function(idx) {
      var sec = sequence[idx];
      var item = document.createElement('div');
      item.className = 'seq-item' +
        (running && idx === secIdx ? ' active' : '') +
        (running && idx < secIdx  ? ' done-item' : '');

      var numS = document.createElement('span');
      numS.className = 'seq-num';
      numS.textContent = sec.bars;

      var sigS = document.createElement('span');
      sigS.className = 'seq-sig';
      sigS.textContent = sec.sigId;

      var nameS = document.createElement('span');
      nameS.className = 'seq-name';
      nameS.textContent = sec.name || ('SecciÃ³ ' + (idx+1));

      var del = document.createElement('button');
      del.className = 'seq-del';
      del.type = 'button';
      del.textContent = 'âœ•';
      del.addEventListener('click', function(e) {
        e.stopPropagation();
        if (running) return;
        sequence.splice(idx, 1);
        if (secIdx >= sequence.length) secIdx = Math.max(0, sequence.length-1);
        renderSeqList();
        refreshIdle();
      });

      item.appendChild(numS);
      item.appendChild(sigS);
      item.appendChild(nameS);
      item.appendChild(del);

      item.addEventListener('click', function() {
        if (running) return;
        secIdx = idx;
        renderSeqList();
        refreshIdle();
      });

      seqList.appendChild(item);
    })(i);
  }

  var total = 0;
  for (var j=0; j<sequence.length; j++) total += sequence[j].bars;
  seqTotal.textContent = sequence.length ? (total + ' compassos totals') : '';
}

// â”€â”€ AFEGIR SECCIÃ“ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doAdd() {
  var barsVal = parseInt(newBarsIn.value, 10);
  if (isNaN(barsVal)) barsVal = 16;
  var bars  = clamp(barsVal, 1, 999);
  var sigId = SIGS[newSigIdx].id;
  var name  = newNameIn.value.trim();
  sequence.push({ bars: bars, sigId: sigId, name: name });
  newNameIn.value = '';
  newBarsIn.value = bars; // keep value clean
  renderSeqList();
  refreshIdle();
}

// MÃºltiples events per mÃ xima compatibilitat mÃ²bil
btnAdd.addEventListener('click', doAdd);
btnAdd.addEventListener('touchend', function(e) {
  e.preventDefault();
  doAdd();
});

// â”€â”€ BEAT DOTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildBeatDots() {
  beatDots.innerHTML = '';
  subDots.innerHTML  = '';
  if (!sequence.length) { beatLbl.textContent = ''; return; }
  var sig = curSig();
  beatLbl.textContent = subdivMode ? (sig.id + ' Â· subdividit') : sig.id;
  for (var b=0; b<sig.beats; b++) {
    var d = document.createElement('div');
    d.className = 'bdot' + (b===0 ? ' acc' : '');
    beatDots.appendChild(d);
  }
  if (subdivMode) {
    for (var s=0; s<sig.beats*2; s++) {
      var ds = document.createElement('div');
      ds.className = 'bdot sub';
      subDots.appendChild(ds);
    }
  }
}
function updateBeatDots() {
  var bds = beatDots.querySelectorAll('.bdot');
  var sds = subDots.querySelectorAll('.bdot.sub');
  for (var i=0; i<bds.length; i++) bds[i].classList.toggle('on', i===currentBeat);
  if (subdivMode) {
    var g = currentBeat*2 + currentSub;
    for (var j=0; j<sds.length; j++) sds[j].classList.toggle('on', j===g);
  }
}

// â”€â”€ SUBDIVISIÃ“ DESC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateSubdivDesc() {
  if (!subdivMode) {
    subdivDesc.textContent = '1 cop = 1 temps';
    subdivDetail.textContent = '';
  } else {
    subdivDesc.textContent = '1 cop = 1 subdivisiÃ³ (Ã—2)';
    subdivDetail.textContent = 'Cada temps s\'omple amb 2 cops';
  }
}
subdivToggle.addEventListener('change', function() {
  subdivMode = subdivToggle.checked;
  updateSubdivDesc();
  if (!running) refreshIdle();
});

// â”€â”€ CAPÃ‡ALERA SECCIÃ“ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateSecHdr() {
  var sec = sequence[secIdx];
  secSig.textContent  = sec ? sec.sigId : 'â€”';
  secName.textContent = sec ? (sec.name || ('SecciÃ³ ' + (secIdx+1))) : '';
  secProg.textContent = sequence.length ? ((secIdx+1) + '/' + sequence.length) : '';
}

// â”€â”€ IDLE DISPLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshIdle() {
  if (!sequence.length) {
    bigNum.textContent  = 'â€”';
    ofTotal.textContent = '';
    secSig.textContent  = 'â€”';
    secName.textContent = '';
    secProg.textContent = '';
    buildBeatDots();
    return;
  }
  var sec = sequence[secIdx] || sequence[0];
  secSig.textContent  = sec.sigId;
  secName.textContent = sec.name || ('SecciÃ³ ' + (secIdx+1));
  secProg.textContent = (secIdx+1) + '/' + sequence.length;
  bigNum.textContent  = sec.bars;
  ofTotal.textContent = 'de ' + sec.bars;
  progBar.style.width = '0%';
  buildBeatDots();
  updateBeatDots();
}

// â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetState() {
  running = false;
  secIdx = 0;
  remainingBars = sequence.length ? sequence[0].bars : 0;
  currentBeat = 0; currentSub = 0; tapCount = 0;
  overlay.classList.remove('show');
  display.className = 'display';
  statusLine.className = 'status';
  statusLine.textContent = sequence.length ? 'Prem START per iniciar' : 'Afegeix seccions i prem START';
  tapLabel.textContent = 'TAP Â· POLSA';
  tapHint.textContent  = 'Toca aquÃ­ Â· L2/LT Â· Espai';
  btnStart.textContent = 'â–¶ START';
  renderSeqList();
  refreshIdle();
}

// â”€â”€ START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startCounting() {
  if (running || !sequence.length) return;
  warnAt = clamp(parseInt(warnInput.value, 10) || 5, 1, 99);
  running = true;
  tapCount = 0; currentBeat = 0; currentSub = 0;
  remainingBars = sequence[secIdx].bars;
  tapsNeeded = tapsFor(curSig());
  overlay.classList.remove('show');
  display.className = 'display';
  statusLine.className = 'status';
  statusLine.textContent = 'Escoltantâ€¦';
  tapLabel.textContent = 'POLSA';
  tapHint.textContent  = 'L2/LT Â· Toca Â· Espai';
  btnStart.textContent = 'â¹ Aturar';
  updateSecHdr();
  bigNum.textContent  = remainingBars;
  ofTotal.textContent = 'de ' + sequence[secIdx].bars;
  progBar.style.width = '0%';
  buildBeatDots(); updateBeatDots();
  renderSeqList();
}

function toggleStart() {
  if (running) {
    running = false;
    statusLine.className = 'status';
    statusLine.textContent = 'Aturat';
    btnStart.textContent = 'â–¶ START';
    tapLabel.textContent = 'TAP Â· POLSA';
    tapHint.textContent  = 'Toca aquÃ­ Â· L2/LT Â· Espai';
  } else {
    startCounting();
  }
}

// â”€â”€ AVANÃ‡AR SECCIÃ“ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function advanceSection() {
  secIdx++;
  if (secIdx >= sequence.length) {
    running = false;
    display.className = 'display done';
    statusLine.className = 'status done';
    statusLine.textContent = 'âœ“ Tota la partitura completada!';
    tapLabel.textContent = 'âœ“ FI';
    tapHint.textContent  = '';
    btnStart.textContent = 'â–¶ START';
    if (canVibrate) navigator.vibrate([200,80,200,80,400]);
    renderSeqList();
    setTimeout(function() { overlay.classList.add('show'); }, 350);
    return;
  }
  var sec = sequence[secIdx];
  remainingBars = sec.bars;
  tapsNeeded    = tapsFor(getSig(sec.sigId));
  currentBeat = 0; currentSub = 0; tapCount = 0;
  display.className = 'display sflash';
  setTimeout(function() { if (running) display.className = 'display'; }, 450);
  statusLine.className = 'status next';
  statusLine.textContent = 'â–¶ SecciÃ³ ' + (secIdx+1) + (sec.name ? ' Â· '+sec.name : '') + ' â€” ' + sec.sigId;
  updateSecHdr();
  bigNum.textContent  = remainingBars;
  ofTotal.textContent = 'de ' + sec.bars;
  progBar.style.width = '0%';
  buildBeatDots(); updateBeatDots();
  if (canVibrate) navigator.vibrate([60,40,120]);
  renderSeqList();
  setTimeout(function() {
    if (statusLine.classList.contains('next')) {
      statusLine.className = 'status';
      statusLine.textContent = 'Escoltantâ€¦';
    }
  }, 2200);
}

// â”€â”€ POLSACIÃ“ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onTap() {
  if (!running) { startCounting(); return; }
  if (!sequence.length || secIdx >= sequence.length) return;

  var sig = curSig();

  if (subdivMode) {
    currentSub++;
    if (currentSub >= 2) { currentSub = 0; currentBeat++; }
  } else {
    currentBeat++;
  }
  tapCount++;

  if (canVibrate) {
    var isDown = (currentBeat === 0 && currentSub === 0);
    navigator.vibrate(isDown ? 18 : 6);
  }
  updateBeatDots();

  if (tapCount >= tapsNeeded) {
    tapCount = 0; currentBeat = 0; currentSub = 0;
    remainingBars--;

    bigNum.classList.remove('pop');
    void bigNum.offsetWidth;
    bigNum.classList.add('pop');
    bigNum.textContent = remainingBars;

    var secTotal = sequence[secIdx].bars;
    ofTotal.textContent = 'de ' + secTotal;
    progBar.style.width = ((secTotal - remainingBars) / secTotal * 100) + '%';
    updateBeatDots();

    if (remainingBars <= 0) { advanceSection(); return; }

    if (remainingBars <= warnAt) {
      display.className = 'display warning';
      statusLine.className = 'status warn';
      statusLine.textContent = 'âš  Queden ' + remainingBars + ' compassos!';
      if (remainingBars === warnAt && canVibrate) navigator.vibrate([80,40,80,40,80]);
    } else {
      display.className = 'display';
      statusLine.className = 'status';
      statusLine.textContent = 'CompÃ s ' + (secTotal - remainingBars) + '/' + secTotal;
    }
  } else {
    statusLine.textContent = subdivMode
      ? ('Temps ' + (currentBeat+1) + '/' + sig.beats + ' Â· Sub ' + (currentSub+1) + '/2')
      : ('Temps ' + currentBeat + '/' + sig.beats);
  }
}

// â”€â”€ EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
btnStart.addEventListener('click', toggleStart);
btnReset.addEventListener('click', resetState);

warnInput.addEventListener('change', function() {
  warnAt = clamp(parseInt(warnInput.value, 10) || 5, 1, 99);
  warnInput.value = warnAt;
});

overlay.addEventListener('click', function() {
  overlay.classList.remove('show');
  resetState();
});

// TAP ZONE â€” touch
var tapping = false;
tapZone.addEventListener('touchstart', function(e) {
  e.preventDefault();
  if (tapping) return;
  tapping = true;
  tapZone.classList.add('pressing');
  var t = e.changedTouches[0];
  spawnRipple(t.clientX, t.clientY);
  onTap();
}, { passive: false });

tapZone.addEventListener('touchend', function(e) {
  e.preventDefault();
  tapping = false;
  tapZone.classList.remove('pressing');
}, { passive: false });

tapZone.addEventListener('touchcancel', function() {
  tapping = false;
  tapZone.classList.remove('pressing');
});

// TAP ZONE â€” mouse
tapZone.addEventListener('mousedown', function(e) {
  // Evita doble-fire en dispositius tÃ ctils
  if (tapping) return;
  spawnRipple(e.clientX, e.clientY);
  onTap();
});

function spawnRipple(cx, cy) {
  var r  = tapZone.getBoundingClientRect();
  var el = document.createElement('span');
  el.className = 'ripple';
  var sz = Math.max(r.width, r.height);
  el.style.cssText = 'width:'+sz+'px;height:'+sz+'px;left:'+(cx-r.left-sz/2)+'px;top:'+(cy-r.top-sz/2)+'px';
  tapZone.appendChild(el);
  setTimeout(function() { if (el.parentNode) el.parentNode.removeChild(el); }, 600);
}

// TECLAT
document.addEventListener('keydown', function(e) {
  if (e.repeat) return;
  var tag = e.target.tagName;
  if (tag === 'INPUT' || tag === 'TEXTAREA') return;
  if (e.code === 'Space' || e.code === 'Enter') { e.preventDefault(); onTap(); }
  if (e.code === 'KeyR') resetState();
  if (e.code === 'KeyS') toggleStart();
});

// GAMEPAD
function gpBtn(gp, idx) {
  var b = gp.buttons[idx];
  return b ? (b.pressed || b.value > 0.5) : false;
}
function gamepadLoop() {
  var gps = [];
  if (navigator.getGamepads) {
    var raw = navigator.getGamepads();
    for (var i=0; i<raw.length; i++) { if (raw[i]) gps.push(raw[i]); }
  }
  if (!gps.length) { gpRAF = requestAnimationFrame(gamepadLoop); return; }
  var gp = gps[0];
  if (!gpConnected) {
    gpConnected = true;
    gpDot.classList.add('on');
    gpLabel.textContent = (gp.id || 'Gamepad').substring(0, 34) + ' âœ“';
  }
  COUNT_BTNS.forEach(function(i) {
    var now = gpBtn(gp, i);
    if (now && !lastBtns[i]) onTap();
    lastBtns[i] = now;
  });
  START_BTNS.forEach(function(i) {
    var now = gpBtn(gp, i);
    if (now && !lastBtns['s'+i]) toggleStart();
    lastBtns['s'+i] = now;
  });
  RESET_BTNS.forEach(function(i) {
    var now = gpBtn(gp, i);
    if (now && !lastBtns['r'+i]) resetState();
    lastBtns['r'+i] = now;
  });
  gpRAF = requestAnimationFrame(gamepadLoop);
}
if (window.addEventListener) {
  window.addEventListener('gamepadconnected', function() { if (!gpRAF) gamepadLoop(); });
  window.addEventListener('gamepaddisconnected', function() {
    var gps = [];
    if (navigator.getGamepads) {
      var raw = navigator.getGamepads();
      for (var i=0; i<raw.length; i++) { if (raw[i]) gps.push(raw[i]); }
    }
    if (!gps.length) {
      gpConnected = false;
      gpDot.classList.remove('on');
      gpLabel.textContent = 'Gamepad desconnectat';
    }
  });
}
setInterval(function() {
  if (!gpConnected && !gpRAF) {
    var gps = [];
    if (navigator.getGamepads) {
      var raw = navigator.getGamepads();
      for (var i=0; i<raw.length; i++) { if (raw[i]) gps.push(raw[i]); }
    }
    if (gps.length) gamepadLoop();
  }
}, 1000);

// â”€â”€ SERVICE WORKER (PWA offline) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ('serviceWorker' in navigator) {
  // Inline service worker via blob
  var swCode = [
    "const CACHE='compassos-v1';",
    "self.addEventListener('install',e=>{ self.skipWaiting(); });",
    "self.addEventListener('activate',e=>{ e.waitUntil(self.clients.claim()); });",
    "self.addEventListener('fetch',e=>{ e.respondWith(fetch(e.request).catch(()=>caches.match(e.request))); });"
  ].join('\n');
  var blob = new Blob([swCode], {type:'application/javascript'});
  var swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl).catch(function(){});
}

// â”€â”€ INICI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
buildNewSigGrid();
updateSubdivDesc();
renderSeqList();
refreshIdle();
</script>
</body>
</html>
